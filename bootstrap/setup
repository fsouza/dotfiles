#!/usr/bin/env python3
import os
import shutil
import subprocess
import sys
from pathlib import Path

BASEDIR = Path(__file__).parent.parent.absolute()
SYMLINK_SKIP = set(os.getenv("FSOUZA_BOOTSTRAP_LINK_SKIP", "").split())


def create_symlink(name: str, source: Path, target: Path) -> None:
    if name not in SYMLINK_SKIP:
        if target.exists() and not target.is_symlink():
            target.unlink()

        if not target.is_symlink():
            target.symlink_to(source)


def main() -> int:
    home = Path.home()
    config_dir = home / ".config"
    config_dir.mkdir(exist_ok=True)

    home_files = [".zshrc", ".editorconfig"]
    for file in home_files:
        create_symlink(file, BASEDIR / file, home / file)

    xdg_files = ["alacritty.yml", "rgrc"]
    for file in xdg_files:
        create_symlink(file, BASEDIR / file, config_dir / file)

    xdg_dirs = ["git", "fd", "utop", "tmux"]
    for xdg_dir in xdg_dirs:
        target = config_dir / xdg_dir

        if target.is_dir() and not target.is_symlink():
            sys.stderr.write(f"{target} alread exists, skipping")
            return 2

        create_symlink(xdg_dir, BASEDIR / xdg_dir, target)

    os_bootstrap = BASEDIR / "bootstrap" / f"{sys.platform}-setup"
    if os_bootstrap.exists():
        subprocess.check_call([os_bootstrap])

    (home / ".zsh_sessions_disable").touch(exist_ok=True)

    if shutil.which("brew") != "":
        subprocess.check_call(["brew", "update"])
        subprocess.check_call(
            [
                "brew",
                "bundle",
                "--no-lock",
                "--no-upgrade",
                "--file",
                BASEDIR / "bootstrap" / "Brewfile",
            ],
        )

    if shutil.which("nvim") != "":
        subprocess.check_call(
            ["make", "-C", BASEDIR],
            env={
                **os.environ,
                "NVIM_DEBUG": "1",
                "FSOUZA_DOTFILES_DIR": os.getenv("FSOUZA_DOTFILES_DIR", str(BASEDIR)),
            },
        )

    return 0


if __name__ == "__main__":
    sys.exit(main())
