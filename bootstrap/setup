#!/usr/bin/env bash

set -euo pipefail

os=$(uname -s)
basedir=$(cd "$(dirname "${0}")"/.. && pwd -P)

function gen_hammerspoon_config {
	local nvim_cache_dir temp_file fennel

	nvim_cache_dir=$(nvim --clean --headless -E -u NORC -R +'echo stdpath("cache")' +q 2>&1)
	fennel=${nvim_cache_dir}/hr/bin/fennel
	temp_file=$(mktemp)

	"${fennel}" --globals hs -c "${basedir}"/hammerspoon/init.fnl >"${temp_file}" &&
		mkdir -p ~/.hammerspoon &&
		mv "${temp_file}" ~/.hammerspoon/init.lua
}

home_files=(.zshrc .editorconfig)
for file in "${home_files[@]}"; do
	ln -sf "${basedir}"/"${file}" "${HOME}"/"${file}"
done

mkdir -p "${HOME}"/.config
xdg_files=(tmux.conf alacritty.yml rgrc)
for file in "${xdg_files[@]}"; do
	ln -sf "${basedir}"/"${file}" "${HOME}"/.config/"${file}"
done

xdg_dirs=(git fd utop)
for dir in "${xdg_dirs[@]}"; do
	link="${HOME}"/.config/"${dir}"
	if ! [ -L "${link}" ] && [ -d "${link}" ]; then
		echo >&2 "${link} exists, aborting"
		exit 2
	fi

	if ! [ -L "${link}" ]; then
		ln -s "${basedir}"/"${dir}" "${link}"
	fi
done

export basedir
if [ -f "${basedir}"/bootstrap/"${os}"-setup ]; then
	"${basedir}"/bootstrap/"${os}"-setup
fi

touch "${HOME}"/.zsh_sessions_disable

if command -v nvim &>/dev/null; then
	env NVIM_DEBUG=1 make -C "${basedir}"/nvim &&
		# need to do it here because fennel is installed as part of neovim.
		gen_hammerspoon_config
fi
