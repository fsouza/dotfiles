#!/usr/bin/env bash

set -euo pipefail

function gen_alacritty_config {
	envsubst <"${basedir}"/alacritty.yml >~/.config/alacritty.yml
}

os=$(uname -s)
basedir=$(
	cd "$(dirname "${0}")"/..
	pwd -P
)

home_files=(.zshrc .editorconfig)
for file in "${home_files[@]}"; do
	ln -sf "${basedir}"/"${file}" "${HOME}"/"${file}"
done

mkdir -p "${HOME}"/.config
xdg_files=(tmux.conf rgrc)
for file in "${xdg_files[@]}"; do
	ln -sf "${basedir}"/"${file}" "${HOME}"/.config/"${file}"
done

xdg_dirs=(git fd utop)
for dir in "${xdg_dirs[@]}"; do
	link="${HOME}"/.config/"${dir}"
	if ! [ -L "${link}" ] && [ -d "${link}" ]; then
		echo >&2 "${link} exists, aborting"
		exit 2
	fi

	if ! [ -L "${link}" ]; then
		ln -s "${basedir}"/"${dir}" "${link}"
	fi
done

export basedir
if [ -f "${basedir}"/bin/"${os}"-setup ]; then
	"${basedir}"/bin/"${os}"-setup
fi

if command -v nvim &>/dev/null; then
	env NVIM_DEBUG=1 make -C "${basedir}"/nvim
fi

touch "${HOME}"/.zsh_sessions_disable
gen_alacritty_config
