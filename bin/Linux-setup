#!/bin/bash -e

# Yes, this script requires sudo. Life sucks.

CORRETTO8_URL=https://d2znqt9b1bc64u.cloudfront.net/java-1.8.0-amazon-corretto-jdk_8.202.08-2_amd64.deb
CORRETTO11_URL=https://d3pxv6yz143wms.cloudfront.net/11.0.2.9.3/java-11-amazon-corretto-jdk_11.0.2.9-3_amd64.deb
ALACRITTY_VERSION=v0.2.9

basedir=$(cd $(dirname $0)/..; pwd -P)

function rm_dir {
	if [ -n "${1}" ] && [ -d "${1}" ]; then
		rm -rf "${1}"
	fi
}

function apt_update {
	sudo apt update
}

function install_base_dev_tools {
	sudo apt remove -y firefox
	sudo snap install firefox

	echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | sudo debconf-set-selections

	# ruby is installed globally for homebrew
	sudo apt install -y \
		build-essential \
		pkg-config \
		curl \
		file \
		apt-transport-https \
		gnupg-agent \
		software-properties-common \
		ruby \
		xclip \
		libssl-dev \
		virtualenv \
		ttf-mscorefonts-installer \
		pinentry-tty
}

function install_source_code_pro {
	mkdir -p ${HOME}/.fonts
	cp ${basedir}/extra/source-code-pro/SourceCodeVariable-Roman.otf ${HOME}/.fonts/
	fc-cache -f
}

function install_op {
	OP_VERSION=v0.5.5

	mkdir -p ${HOME}/bin
	tmp_dir=$(mktemp -d)
	pushd ${tmp_dir}
	curl -Lo op.zip https://cache.agilebits.com/dist/1P/op/pkg/${OP_VERSION}/op_linux_amd64_${OP_VERSION}.zip
	unzip op.zip
	mv op ${HOME}/bin
	popd

	rm_dir "${tmp_dir}"
}

# really, apt?
function install_remote_deb_packages {
        tmp_dir=$(mktemp -d)

        pushd ${tmp_dir}
                for pkg in ${@}; do
                        curl -LO ${pkg}
                done
                sudo apt install -y ./*.deb
        popd

	rm_dir "${tmp_dir}"
}

function install_additional_tools {
	install_remote_deb_packages \
		${CORRETTO8_URL} \
		${CORRETTO11_URL} \
		https://github.com/jwilm/alacritty/releases/download/${ALACRITTY_VERSION}/Alacritty-${ALACRITTY_VERSION}_amd64.deb \
		https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb

	install_source_code_pro
	install_op

	mkdir -p ${HOME}/bin
	ln -sf /usr/bin/java ${HOME}/bin/java
}

# based on instructions from the official Docker docs.
function install_docker {
	sudo apt-key adv --fetch-keys https://download.docker.com/linux/ubuntu/gpg
	sudo add-apt-repository -y "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
	sudo apt update
	sudo apt install -y docker-ce docker-ce-cli containerd.io
	sudo usermod -a -G docker $(whoami)
}

# don't ask me about it
function install_legacy_firefox {
	if ! [ -d $HOME/firefox ]; then
		sudo apt install libgtk2.0 -y
		curl -L https://ftp.mozilla.org/pub/firefox/releases/52.9.0esr/linux-x86_64/en-US/firefox-52.9.0esr.tar.bz2 -o /tmp/firefox.tar.bz2
		tar -C $HOME -xjf /tmp/firefox.tar.bz2

		# Hack to disable updates
		rm $HOME/firefox/updater
		cat > $HOME/firefox/defaults/pref/channel-prefs.js <<'EOF'
pref("app.update.channel", "esr");
pref("app.update.auto", false);
pref("app.update.enabled", false);
pref("app.update.silent", true);
pref("browser.shell.checkDefaultBrowser", false);
EOF
	fi
}

function cleanup {
	sudo apt autoremove -y
}

function tune_dconf {
	# move titlebar buttons to the left
	dconf write /org/gnome/desktop/wm/preferences/button-layout "'close,minimize,maximize:'"

	# set monospace-font-name
	dconf write /org/gnome/desktop/interface/monospace-font-name "'Source Code Variable 13'"

	# key repetition
	dconf write /org/gnome/desktop/peripherals/keyboard/delay 250
	dconf write /org/gnome/desktop/peripherals/keyboard/repeat-interval 15

	# clock config
	dconf write /org/gtk/settings/file-chooser/clock-format "'12h'"
	dconf write /org/gnome/desktop/interface/clock-show-date true
	dconf write /org/gnome/desktop/datetime/automatic-timezone true

	# disable notifications
	dconf write /org/gnome/desktop/notifications/show-banners false
	dconf write /org/gnome/desktop/notifications/show-in-lock-screen false

	# gnome-terminal
	profile="$(uuidgen)"

	dconf write /org/gnome/terminal/legacy/profiles:/list "['${profile}']"
	dconf write /org/gnome/terminal/legacy/profiles:/default "'${profile}'"

	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/visible-name "'default'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/allow-bold false
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/background-color "'rgb(255,255,255)'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/foreground-color "'rgb(0,0,0)'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/cursor-blink-mode "'off'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/default-show-menubar false
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/font "'Source Code Variable 13'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/menu-accelerator-enabled false
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/scrollback-lines 50000
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/scrollbar-policy "'never'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/use-theme-colors false
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/text-blink-mode "'never'"

	# match alacritty.yml
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/palette "['rgb(0,0,0)', 'rgb(201,27,0)', 'rgb(0,182,0)', 'rgb(199,196,0)', 'rgb(2,37,199)', 'rgb(201,48,198)', 'rgb(0,197,199)', 'rgb(199,199,199)', 'rgb(101,101,101)', 'rgb(255,109,103)', 'rgb(95,249,103)', 'rgb(254,251,103)', 'rgb(104,113,255)', 'rgb(255,118,255)', 'rgb(95,253,255)', 'rgb(255,255,255)']"

	# night light
	dconf write /org/gnome/settings-daemon/plugins/color/night-light-enabled true
	dconf write /org/gnome/settings-daemon/plugins/color/night-light-schedule-automatic true

	# mouse speed
	dconf write /org/gnome/desktop/peripherals/touchpad/speed 0.61151079136690645

	# wayland scaling, may vary with resolution. This is my preferred setting for a 2K monitor
	dconf write /org/gnome/mutter/experimental-features "['scale-monitor-framebuffer']"

	# lock screen & notifications
	dconf write /org/gnome/desktop/screensaver/lock-delay 0
	dconf write /org/gnome/desktop/notifications/show-in-lock-screen false
	dconf write /org/gnome/desktop/session/idle-delay 900
	dconf write /org/gnome/desktop/notifications/show-banners false

	# media handling
	dconf write /org/gnome/desktop/media-handling/autorun-never true

	# dock settings
	dconf write /org/gnome/shell/extensions/dash-to-dock/dock-fixed false
}

function main {
	apt_update
	install_base_dev_tools
	install_additional_tools
	install_docker
	install_legacy_firefox
	cleanup
	tune_dconf
}

main
