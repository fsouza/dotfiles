#!/bin/zsh -e

# Yes, this script requires sudo. Life sucks.

CORRETTO11_URL=https://corretto.aws/downloads/latest/amazon-corretto-11-x64-linux-jdk.deb

basedir=$(cd $(dirname "$0")/..; pwd -P)

function rm_dir {
	if [ -n "${1}" ] && [ -d "${1}" ]; then
		rm -rf "${1}"
	fi
}

function apt_update {
	sudo apt update
}

function install_base_dev_tools {
	echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | sudo debconf-set-selections

	echo postfix postfix/mailname string "$(hostname -s)" | sudo debconf-set-selections
	echo postfix postfix/main_mailer_type string 'Local only' | sudo debconf-set-selections

	# ruby is installed globally for homebrew
	sudo apt install -y \
		build-essential \
		pkg-config \
		curl \
		file \
		apt-transport-https \
		gnupg-agent \
		software-properties-common \
		ruby \
		ruby-dev \
		xclip \
		libssl-dev \
		virtualenv \
		ttf-mscorefonts-installer \
		postfix \
		exfat-utils \
		exfat-fuse \
		pinentry-tty \
		zsh \
		docker.io
}

function install_source_code_pro {
	mkdir -p "${HOME}/.fonts"
	cp "${basedir}"/extra/source-code-pro/*.otf "${HOME}/.fonts/"
	fc-cache -f
}

# really, apt?
function install_remote_deb_packages {
        tmp_dir=$(mktemp -d)

        pushd "${tmp_dir}"
                for pkg in ${@}; do
                        curl -LO "${pkg}"
                done
                sudo apt install -y ./*.deb
        popd

	rm_dir "${tmp_dir}"
}

function install_additional_tools {
	install_remote_deb_packages \
		"${CORRETTO11_URL}" \
		https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb

	install_source_code_pro

	mkdir -p "${HOME}/bin"
	ln -sf /usr/bin/java "${HOME}/bin/java"
}

function install_alacritty {
	if ! command -v cargo &>/dev/null; then
		curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
	fi

	if [ ! -d "$HOME/Projects/os/3/alacritty" ]; then
		mkdir -p "$HOME/Projects/os/3/"
		git clone https://github.com/alacritty/alacritty.git "$HOME/Projects/os/3/alacritty"
	fi

	mkdir -p "${HOME}/Applications/alacritty"
	cp "${basedir}/extra/etc/alacritty.svg" "${HOME}/Applications/alacritty"
	(
		cd "${HOME}/Projects/os/3/alacritty"
		git pull
		cargo build --release
		cp -f -v target/release/alacritty "${HOME}/Applications/alacritty/alacritty"
	)

	cat > "${HOME}/.local/share/applications/alacritty.desktop" <<EOF
[Desktop Entry]
Encoding=UTF-8
Name=Alacritty
Exec=/usr/bin/env WAYLAND_DISPLAY="" ${HOME}/Applications/alacritty/alacritty
Icon=${HOME}/Applications/alacritty/alacritty.svg
Type=Application
EOF
}

function install_gpmdp_shortcut {
	cat > "${HOME}/.local/share/applications/google-play-music-desktop-player.desktop" <<EOF
[Desktop Entry]
Name=Google Play Music Desktop Player
Comment=An Electron wrapper for Google Play Music
GenericName=Google Play Music Desktop Player
Exec=${basedir}/bin/wayland-wrap google-play-music-desktop-player %U
Icon=${basedir}/extra/etc/google-play-music.png
Type=Application
StartupNotify=true
Categories=AudioVideo;Audio;
EOF
}

function cleanup {
	sudo apt autoremove -y
}

function tune_dconf {
	# move titlebar buttons to the left
	dconf write /org/gnome/desktop/wm/preferences/button-layout "'close,minimize,maximize:'"

	# icons on desktop
	dconf write /org/gnome/shell/extensions/desktop-icons/icon-size "'large'"
	dconf write /org/gnome/shell/extensions/desktop-icons/show-home false

	# set fonts
	dconf write /org/gnome/desktop/interface/monospace-font-name "'Source Code Pro 11'"
	dconf write /org/gnome/desktop/interface/document-font-name "'Ubuntu 11'"

	# key repetition
	dconf write /org/gnome/desktop/peripherals/keyboard/delay 200
	dconf write /org/gnome/desktop/peripherals/keyboard/repeat-interval 10
	dconf write /org/gnome/desktop/input-sources/xkb-options "['compose:ralt']"

	# clock config
	dconf write /org/gtk/settings/file-chooser/clock-format "'12h'"
	dconf write /org/gnome/desktop/interface/clock-format "'12h'"
	dconf write /org/gnome/desktop/interface/clock-show-date true
	dconf write /org/gnome/desktop/datetime/automatic-timezone true

	# disable notifications
	dconf write /org/gnome/desktop/notifications/show-banners true
	dconf write /org/gnome/desktop/notifications/show-in-lock-screen false

	# gnome-terminal
	dconf write /org/gnome/terminal/legacy/default-show-menubar false
	dconf write /org/gnome/terminal/legacy/menu-accelerator-enabled false

	profile="$(uuidgen)"

	dconf write /org/gnome/terminal/legacy/profiles:/list "['${profile}']"
	dconf write /org/gnome/terminal/legacy/profiles:/default "'${profile}'"

	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/visible-name "'default'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/allow-bold false
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/background-color "'rgb(255,255,255)'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/foreground-color "'rgb(0,0,0)'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/cursor-blink-mode "'off'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/font "'Source Code Pro 9'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/scrollback-lines 50000
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/scrollbar-policy "'never'"
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/use-theme-colors false
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/text-blink-mode "'never'"

	# match alacritty.yml
	dconf write /org/gnome/terminal/legacy/profiles:/:${profile}/palette "['rgb(0,0,0)', 'rgb(201,27,0)', 'rgb(0,182,0)', 'rgb(199,196,0)', 'rgb(2,37,199)', 'rgb(201,48,198)', 'rgb(0,197,199)', 'rgb(199,199,199)', 'rgb(101,101,101)', 'rgb(255,109,103)', 'rgb(95,249,103)', 'rgb(254,251,103)', 'rgb(104,113,255)', 'rgb(255,118,255)', 'rgb(95,253,255)', 'rgb(255,255,255)']"

	# night light
	dconf write /org/gnome/settings-daemon/plugins/color/night-light-enabled true
	dconf write /org/gnome/settings-daemon/plugins/color/night-light-schedule-automatic true

	# mouse & touchpad speed
	dconf write /org/gnome/desktop/peripherals/touchpad/speed 0.5625
	dconf write /org/gnome/desktop/peripherals/mouse/speed 0.065693430656934337

	# wayland/x11 scaling, may vary with resolution. This is my preferred setting for a 2K monitor
	dconf write /org/gnome/mutter/experimental-features "['scale-monitor-framebuffer', 'x11-randr-fractional-scaling']"

	# lock screen & notifications
	dconf write /org/gnome/desktop/screensaver/lock-delay 0
	dconf write /org/gnome/desktop/notifications/show-in-lock-screen false
	dconf write /org/gnome/desktop/session/idle-delay 900
	dconf write /org/gnome/desktop/notifications/show-banners false

	# media handling
	dconf write /org/gnome/desktop/media-handling/autorun-never true

	# dock settings
	dconf write /org/gnome/shell/extensions/dash-to-dock/dock-fixed false

	# top bar
	dconf write /org/gnome/shell/enable-hot-corners true
	dconf write /org/gnome/desktop/interface/show-battery-percentage true

	# dock items
	dconf write /org/gnome/shell/favorite-apps "['firefox.desktop', 'alacritty.desktop', 'zevdocs_zevdocs.desktop', 'slack_slack.desktop', 'google-play-music-desktop-player.desktop']"

	# close with alt+q, super+q or alt+f4
	dconf write /org/gnome/desktop/wm/keybindings/close "['<Alt>q', '<Super>q', '<Alt>F4']"

	# switch applications with alt+tab
	dconf write /org/gnome/desktop/wm/keybindings/switch-windows "@as []"
	dconf write /org/gnome/desktop/wm/keybindings/switch-windows-backward "@as []"
	dconf write /org/gnome/desktop/wm/keybindings/switch-applications "['<Alt>Tab']"
	dconf write /org/gnome/desktop/wm/keybindings/switch-applications-backward "['<Shift><Alt>Tab']"
}

function main {
	apt_update
	install_base_dev_tools
	install_additional_tools
	install_alacritty
	install_gpmdp_shortcut
	cleanup
	tune_dconf
}

main
