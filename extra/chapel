CHAPEL_CODE=${HOME}/opt/src/chapel-code

function _clone_chpl() {
	mkdir -p "$CHAPEL_CODE"
	git clone https://github.com/chapel-lang/chapel.git "$1"
}

function _load_chpl() {
	location="${CHAPEL_CODE}/chapel-${1}"
	if [ ! -d "$location" ]; then _clone_chpl "$location"; fi
	source "${location}/util/setchplenv.sh" > /dev/null
	export CHPL_TARGET_CPU=native CHPL_REGEXP=re2 CHPL_AUX_FILESYS=curl CHPL_DEVELOPER=1
	export CHPL_MODULE_PATH=${HOME}/Projects/chapel-modules
}

function _download_and_build() {
	git -C "$CHPL_HOME" pull --rebase
	make -C "$CHPL_HOME" -f "$CHPL_HOME/Makefile" -j
	make -C "$CHPL_HOME" -f "$CHPL_HOME/Makefile" chpldoc
	make -C "$CHPL_HOME" -f "$CHPL_HOME/Makefile" docs
}

function _build_mason() {
	make -C "$CHPL_HOME" -f "$CHPL_HOME/Makefile" mason
}

function _update_chapel_gasnet() {
	chapel_gasnet
	_download_and_build
}

function _update_chapel_basic() {
	chapel_basic
	_download_and_build
	_build_mason
}

function update_chapel() {
	_update_chapel_basic
	_update_chapel_gasnet
}

function clean_chapel() {
	for d in $(ls -d ${CHAPEL_CODE}/chapel-*); do
		git -C $d clean -dfX
	done
}

function chapel_gasnet() {
	_load_chpl gasnet
	export CHPL_COMM=gasnet GASNET_SPAWNFN=L GASNET_MASTERIP=127.0.0.1
}

function chapel_basic() {
	_load_chpl basic
	unset CHPL_COMM GASNET_SPAWNFN GASNET_MASTERIP
}

[ -d $CHAPEL_CODE ] && chapel_basic
