CHAPEL_CODE=${HOME}/opt/src/chapel-code

function _load_chpl() {
	source ${CHAPEL_CODE}/chapel-${1}/util/setchplenv.bash > /dev/null
	export CHPL_TARGET_ARCH=native CHPL_REGEXP=re2 CHPL_AUX_FILESYS=curl CHPL_DEVELOPER=1
	export CHPL_MODULE_PATH=${HOME}/Projects/chapel-modules
}

function _download_and_build() {
	git --git-dir="$CHPL_HOME/.git" --work-tree="$CHPL_HOME" pull --rebase
	make -C "$CHPL_HOME" -f "$CHPL_HOME/Makefile" -j
	make -C "$CHPL_HOME" -f "$CHPL_HOME/Makefile" chpldoc
}

function _update_chapel_gasnet() {
	chapel_gasnet
	_download_and_build
}

function _update_chapel_basic() {
	chapel_basic
	_download_and_build
}

function update_chapel() {
	_update_chapel_basic
	_update_chapel_gasnet
}

function clean_chapel() {
	for d in $(ls -d ${CHAPEL_CODE}/chapel-*); do
		git --git-dir=${d}/.git --work-tree=${d} clean -dfX
	done
}

function chapel_gasnet() {
	_load_chpl gasnet
	export CHPL_COMM=gasnet GASNET_SPAWNFN=L GASNET_MASTERIP=127.0.0.1
}

function chapel_basic() {
	_load_chpl basic
	unset CHPL_COMM GASNET_SPAWNFN GASNET_MASTERIP
}

[ -d $CHAPEL_CODE ] && chapel_basic
