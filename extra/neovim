NEOVIM_INSTALL_PREFIX=${HOME}/opt/neovim
NEOVIM_SRC_DIR=${HOME}/Projects/os/3/neovim

function __use_nvim {
	local executable=${NEOVIM_INSTALL_PREFIX}/bin/nvim
	if [ -x ${executable} ]; then
		if [[ $(which nvim) != ${executable} ]]; then
			prepend_to_path ${NEOVIM_INSTALL_PREFIX}/bin
		fi

		function zvim {
			nvim +'lua require("fsouza.lib.fuzzy").zvim()' ${@}
		}

		export GIT_EDITOR=nvim MANPAGER="nvim +'Man!'"
	else
		unset GIT_EDITOR MANPAGER
	fi
}

function __ensure_neovim_src {
	if ! [ -d ${NEOVIM_SRC_DIR} ]; then
		git clone https://github.com/neovim/neovim.git ${NEOVIM_SRC_DIR}
	fi
}

function __rebuild_neovim {
	(
		cd ${NEOVIM_SRC_DIR} &&
			make \
				CMAKE_BUILD_TYPE=RelWithDebInfo \
				CMAKE_INSTALL_PREFIX=${NEOVIM_INSTALL_PREFIX} \
				CMAKE_EXTRA_FLAGS="-DCMAKE_FIND_FRAMEWORK=LAST ${NVIM_CMAKE_EXTRA_FLAGS}" &&
			make install || return
	)
}

function __update_neovim {
	__ensure_neovim_src
	git -C ${NEOVIM_SRC_DIR} pull && __rebuild_neovim
}

function rebootstrap_neovim {
	__ensure_neovim_src
	pushd ${NEOVIM_SRC_DIR} &&
		make distclean &&
		git clean -dfx &&
		rm -rf ${NEOVIM_INSTALL_PREFIX} &&
		__update_neovim &&
		popd
}

function update_neovim {
	(__update_neovim || rebootstrap_neovim) && __use_nvim
}

function enter_demo_mode {
	dir=~/.local/share/nvim/site/after/plugin
	mkdir -p ${dir}
	if [[ ${1} != "--no-color" ]]; then
		cat >${dir}/demo.lua <<EOF
require('fsouza.lib.demo-mode').enable()
EOF
	fi
	${FSOUZA_DOTFILES_DIR}/bootstrap/install-alacritty-config --colors rose-pine --font-size 24
}

function leave_demo_mode {
	rm -f ~/.local/share/nvim/site/after/plugin/demo.lua
	${FSOUZA_DOTFILES_DIR}/bootstrap/install-alacritty-config
}

__use_nvim
